# ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° HayalKiz Bot v2.0

## ğŸ“Š ĞĞ±Ñ‰Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TELEGRAM USER                             â”‚
â”‚                         ğŸ‘¤                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TELEGRAM BOT API                            â”‚
â”‚                    (aiogram 3.x)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     main.py                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Handlers:                                           â”‚   â”‚
â”‚  â”‚  â€¢ /start â†’ language_selection                       â”‚   â”‚
â”‚  â”‚  â€¢ on_language_selection â†’ set language              â”‚   â”‚
â”‚  â”‚  â€¢ on_persona_selection â†’ set persona                â”‚   â”‚
â”‚  â”‚  â€¢ on_message â†’ chat / selfie                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚              â”‚              â”‚                â”‚
      â–¼              â–¼              â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DB    â”‚    â”‚   GPT    â”‚   â”‚  FLUX    â”‚    â”‚ PERSONAS â”‚
â”‚ (db.py) â”‚    â”‚(services â”‚   â”‚(services â”‚    â”‚(personas â”‚
â”‚         â”‚    â”‚_gpt.py)  â”‚   â”‚_flux.py) â”‚    â”‚   .py)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚               â”‚
     â–¼              â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SQLite  â”‚    â”‚ OpenAI   â”‚   â”‚   BFL    â”‚
â”‚  (app   â”‚    â”‚   API    â”‚   â”‚ Flux API â”‚
â”‚  .db)   â”‚    â”‚          â”‚   â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### 1ï¸âƒ£ ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ)

```
User: /start
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py: cmd_start()                 â”‚
â”‚ â€¢ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ·Ñ‹ĞºĞ°      â”‚
â”‚ â€¢ Ğ¯Ğ·Ñ‹Ğº ĞĞ• Ğ½Ğ°Ğ¹Ğ´ĞµĞ½                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° language_selection_keyboard â”‚
â”‚ [ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e] [ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
User: Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py: on_language_selection()     â”‚
â”‚ â€¢ db.set_language(user_id, "ru")     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° webapp_keyboard(lang="ru")  â”‚
â”‚ [ĞœĞ¸Ğ½Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
User: Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ñƒ "Ğ­Ğ»Ğ¸Ñ„"
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py: on_webapp_data()            â”‚
â”‚ â€¢ db.set_persona(user_id, "elif")    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° chat_keyboard(lang="ru")    â”‚
â”‚ [ğŸ“¸ ĞŸĞ¾ĞºĞ°Ğ¶Ğ¸ ÑĞµĞ»Ñ„Ğ¸]                    â”‚
â”‚ [ğŸ‘¥ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ²ÑƒÑˆĞºÑƒ]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2ï¸âƒ£ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞµĞ»Ñ„Ğ¸

```
User: Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ [ğŸ“¸ ĞŸĞ¾ĞºĞ°Ğ¶Ğ¸ ÑĞµĞ»Ñ„Ğ¸]
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py: on_message()                â”‚
â”‚ â€¢ ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚: ÑÑ‚Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞµĞ»Ñ„Ğ¸       â”‚
â”‚ â€¢ user_lang = db.get_language()      â”‚
â”‚ â€¢ persona = db.get_persona()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py: generate_selfie()           â”‚
â”‚ â€¢ Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ Flux          â”‚
â”‚ â€¢ "A beautiful selfie photo of..."   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ services_flux.py:                    â”‚
â”‚   generate_photo_data_uri()          â”‚
â”‚ â€¢ POST Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº BFL API              â”‚
â”‚ â€¢ Polling ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°                    â”‚
â”‚ â€¢ Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ             â”‚
â”‚ â€¢ ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² data URI             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Telegram: message.answer_photo()     â”‚
â”‚ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3ï¸âƒ£ ĞĞ±Ñ‹Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ

```
User: "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ĞšĞ°Ğº Ğ´ĞµĞ»Ğ°?"
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py: on_message()                â”‚
â”‚ â€¢ user_lang = db.get_language()      â”‚
â”‚ â€¢ persona = db.get_persona()         â”‚
â”‚ â€¢ db.add_message(user, text)         â”‚
â”‚ â€¢ history = db.get_recent_messages() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ services_gpt.py:                     â”‚
â”‚   generate_reply(persona, messages,  â”‚
â”‚                  user_lang="ru")     â”‚
â”‚ â€¢ Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ system prompt (RU)       â”‚
â”‚ â€¢ Ğ’Ñ‹Ğ·Ğ¾Ğ² OpenAI API                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py:                             â”‚
â”‚ â€¢ db.add_message(assistant, reply)   â”‚
â”‚ â€¢ message.answer(reply)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—„ï¸ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

```sql
-- Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° user_state
CREATE TABLE user_state (
    user_id TEXT PRIMARY KEY,
    persona TEXT,              -- ĞšĞ¾Ğ´ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ñ‹ (elif, zeynep, ...)
    language TEXT DEFAULT 'tr', -- NEW! Ğ¯Ğ·Ñ‹Ğº (tr/ru)
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° messages
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT,
    role TEXT,                 -- 'user' Ğ¸Ğ»Ğ¸ 'assistant'
    content TEXT,              -- Ğ¢ĞµĞºÑÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## ğŸ§© ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 1. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ (main.py)

```python
# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
@dp.message(CommandStart())
async def cmd_start(message: Message)
    # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°, Ğ²Ñ‹Ğ±Ğ¾Ñ€ ÑĞ·Ñ‹ĞºĞ°

# Callback queries
@dp.callback_query(lambda c: c.data.startswith("lang:"))
async def on_language_selection(callback_query)
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞ·Ñ‹ĞºĞ°

@dp.callback_query(lambda c: c.data.startswith("select_persona:"))
async def on_persona_selection(callback_query)
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ñ‹

# WebApp Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
@dp.message(F.web_app_data)
async def on_webapp_data(message: Message)
    # ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ñ‹ Ğ¸Ğ· Mini App

# Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
@dp.message()
async def on_message(message: Message)
    # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² ÑĞµĞ»Ñ„Ğ¸
```

### 2. ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹

```python
# Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑĞ·Ñ‹ĞºĞ°
def language_selection_keyboard() -> InlineKeyboardMarkup
    # [ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e] [ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹]

# Mini App
def webapp_keyboard(user_lang: str) -> ReplyKeyboardMarkup
    # [Mini Uygulama / ĞœĞ¸Ğ½Ğ¸-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ]

# Ğ§Ğ°Ñ‚ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸
def chat_keyboard(user_lang: str) -> ReplyKeyboardMarkup
    # [ğŸ“¸ Ğ¡ĞµĞ»Ñ„Ğ¸] [ğŸ‘¥ Ğ¡Ğ¼ĞµĞ½Ğ°]

# Fallback Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ñ‹
def persona_selection_keyboard() -> InlineKeyboardMarkup
    # [Ğ­Ğ»Ğ¸Ñ„] [Ğ—ĞµĞ¹Ğ½ĞµĞ¿] [ĞœĞµĞ»Ğ¸Ñ] ...
```

### 3. Ğ¡ĞµÑ€Ğ²Ğ¸ÑÑ‹

```python
# GPT ÑĞµÑ€Ğ²Ğ¸Ñ (services_gpt.py)
class GPTService:
    def generate_reply(persona, messages, user_lang):
        # Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ
        # â€¢ Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ system prompt
        # â€¢ Ğ’Ñ‹Ğ·Ğ¾Ğ² OpenAI API
        # â€¢ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ñ‚ĞµĞºÑÑ‚Ğ°

# Flux ÑĞµÑ€Ğ²Ğ¸Ñ (services_flux.py)
class FluxService:
    async def generate_photo_data_uri(prompt):
        # Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
        # â€¢ POST Ğº BFL API
        # â€¢ Polling Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°
        # â€¢ ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ² base64
        # â€¢ Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ data URI
```

### 4. Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (db.py)

```python
# ĞŸĞµÑ€ÑĞ¾Ğ½Ñ‹
def set_persona(user_id: str, persona: str)
def get_persona(user_id: str) -> str | None

# Ğ¯Ğ·Ñ‹ĞºĞ¸ (NEW!)
def set_language(user_id: str, language: str)
def get_language(user_id: str) -> str

# Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
def add_message(user_id: str, role: str, content: str)
def get_recent_messages(user_id: str, limit=12) -> List[Tuple[str, str]]
```

## ğŸ” Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ

### Ğ’Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ

```python
# Ğ¯Ğ·Ñ‹Ğº
if lang in ["tr", "ru"]:  # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ½Ñ‹Ğµ ÑĞ·Ñ‹ĞºĞ¸
    db_set_language(user_id, lang)

# ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°
persona = get_persona(code)
if persona:  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    db_set_persona(user_id, persona.code)

# API ĞºĞ»ÑÑ‡Ğ¸
settings = get_settings()  # Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
if not settings.telegram_bot_token:
    raise ValueError("Required")
```

### API Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ

```python
# Timeout Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
timeout = aiohttp.ClientTimeout(total=120)

# ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
try:
    result = await api_call()
except Exception as e:
    logger.error(f"Error: {e}")
    return fallback_response
```

## ğŸ“ˆ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

### ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ v2.0

1. **ĞœĞµĞ½ÑŒÑˆĞµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²**
   - Ğ Ğ°Ğ½ÑŒÑˆĞµ: 2 ÑĞ·Ñ‹ĞºĞ° = ~200 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
   - Ğ¢ĞµĞ¿ĞµÑ€ÑŒ: 1 ÑĞ·Ñ‹Ğº = ~100 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
   - Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ: ~50%

2. **Ğ‘Ñ‹ÑÑ‚Ñ€ĞµĞµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹**
   - ĞœĞµĞ½ÑŒÑˆĞµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² â†’ Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ
   - Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ğµ: ~25%

3. **ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**
   - ĞŸĞµÑ€ÑĞ¾Ğ½Ñ‹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·
   - Settings Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·

### Ğ£Ğ·ĞºĞ¸Ğµ Ğ¼ĞµÑÑ‚Ğ°

1. **Flux API** - Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ 10-30 ÑĞµĞº
   - Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°

2. **SQLite** - Ğ¿Ñ€Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
   - Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° PostgreSQL Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°

3. **OpenAI API** - Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
   - Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: retry Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°, fallback ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ

## ğŸ”„ Ğ–Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User: /start    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check language  â”‚â—„â”€â”€â”€ DB: get_language()
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ Found?  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ NO          YES     â”‚
    â–¼             â–¼       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚Languageâ”‚   â”‚ Welcome â”‚ â”‚
â”‚Select  â”‚   â”‚ back    â”‚ â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                    â”‚
    â–¼                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚Select      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚Persona     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chat mode   â”‚
â”‚ [Buttons]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Unit Ñ‚ĞµÑÑ‚Ñ‹ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ)

```python
# test_db.py
def test_set_get_language():
    set_language("123", "ru")
    assert get_language("123") == "ru"

# test_gpt.py
def test_generate_reply_russian():
    reply = gpt.generate_reply(persona, [], "ru")
    assert is_russian(reply)

# test_flux.py
async def test_generate_photo():
    photo = await flux.generate_photo("test")
    assert photo is not None
```

### Integration Ñ‚ĞµÑÑ‚Ñ‹

```bash
# Ğ¢ĞµÑÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ Ñ„Ğ»Ğ¾Ñƒ
1. /start
2. Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑĞ·Ñ‹ĞºĞ°
3. Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ñ‹
4. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
5. Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞµĞ»Ñ„Ğ¸
```

## ğŸ“¦ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

```
aiogram==3.x        # Telegram Bot framework
openai              # OpenAI API client
aiohttp             # Async HTTP client
pydantic            # Settings validation
python-dotenv       # .env Ñ„Ğ°Ğ¹Ğ»Ñ‹
```

## ğŸš€ Deployment

### Development
```bash
python -m app.main
```

### Production (Docker)
```dockerfile
FROM python:3.11
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "-m", "app.main"]
```

---

**Ğ’ĞµÑ€ÑĞ¸Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹**: 2.0  
**ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ**: 30.09.2025
