# 🔍 Диагностика и решение проблемы генерации фото

## 📊 Блок-схема диагностики

```
START
  ↓
┌─────────────────────────────────────┐
│ Генерация фото не работает на проде │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ Локально работает?                  │
└─────────────────────────────────────┘
  ├─ НЕТ → Проверьте локальную настройку (back/keys.env)
  │
  ├─ ДА → Продолжить ↓
  │
  ↓
┌─────────────────────────────────────┐
│ Откройте /debug endpoint            │
│ https://your-app.twc1.net/debug     │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│ Что показывает GEMINI_API_KEY?      │
└─────────────────────────────────────┘
  │
  ├─ "set" → ✅ Ключ установлен
  │           │
  │           ↓
  │         ┌──────────────────────────────┐
  │         │ Проверьте квоту API в Google │
  │         │ aistudio.google.com/apikey   │
  │         └──────────────────────────────┘
  │
  ├─ "NOT SET" → ❌ ПРОБЛЕМА НАЙДЕНА!
  │               │
  │               ↓
  │             ┌─────────────────────────────────┐
  │             │ TimeWeb Cloud → Settings →      │
  │             │ Environment Variables →         │
  │             │ Add: GEMINI_API_KEY             │
  │             └─────────────────────────────────┘
  │               │
  │               ↓
  │             ┌─────────────────────────────────┐
  │             │ Restart приложения              │
  │             └─────────────────────────────────┘
  │               │
  │               ↓
  │             ┌─────────────────────────────────┐
  │             │ Подождать 60 секунд             │
  │             └─────────────────────────────────┘
  │               │
  │               ↓
  │             ┌─────────────────────────────────┐
  │             │ Проверить /debug снова          │
  │             └─────────────────────────────────┘
  │               │
  │               ↓
  │             "set"? → ✅ РЕШЕНО!
  │               │
  │               └─ "NOT SET" → Повторить добавление
  │
  ↓
✅ ГЕНЕРАЦИЯ РАБОТАЕТ
```

## 🎯 Быстрая диагностика (30 секунд)

### Шаг 1: Откройте debug endpoint
```
https://giottobright-back-3800.twc1.net/debug
```

### Шаг 2: Найдите строку GEMINI_API_KEY

#### ✅ Если видите:
```json
"GEMINI_API_KEY": "set"
```
**→ Ключ установлен, проблема не в этом**  
Проверьте:
- Квоты Google API
- Логи приложения на ошибки
- Работоспособность самого API

#### ❌ Если видите:
```json
"GEMINI_API_KEY": "NOT SET - REQUIRED FOR IMAGE GENERATION"
```
**→ ПРОБЛЕМА НАЙДЕНА!**  
Решение: Добавьте переменную в TimeWeb Cloud

#### 🤔 Если debug endpoint не открывается:
**→ Приложение не запущено**  
Проверьте:
- Статус приложения в панели TimeWeb
- Логи запуска

## 📋 Карта проблем и решений

| Симптом | Причина | Решение | Время |
|---------|---------|---------|-------|
| Генерация не работает на проде | GEMINI_API_KEY не установлен | Добавить переменную в TimeWeb | 5 мин |
| Debug показывает "NOT SET" | Переменная не добавлена | Settings → Env Vars → Add | 2 мин |
| Debug показывает "set", но не работает | Квота API исчерпана | Проверить https://aistudio.google.com | 3 мин |
| Debug показывает "set", но не работает | Неверный ключ | Создать новый ключ API | 5 мин |
| После добавления все еще "NOT SET" | Не перезапущено приложение | Restart → Подождать 60 сек | 2 мин |

## 🔎 Детальная проверка

### 1. Проверка переменных окружения

```bash
# Должны быть установлены:
✅ TELEGRAM_BOT_TOKEN=set
✅ OPENAI_API_KEY=set
✅ GEMINI_API_KEY=set          ← КРИТИЧНО для генерации
✅ WEBAPP_URL=set
✅ DATABASE_PATH=set

# Опционально:
⭕ FLUX_API_KEY=set (or not set)
⭕ FLUX_API_URL=set (or not set)
```

### 2. Проверка логов

Откройте логи в TimeWeb Cloud и ищите:

#### ❌ Плохие признаки:
```
❌ Gemini service не инициализирован или нет API ключа
⚠️ GEMINI_API_KEY не установлен
ERROR: Failed to generate image
```

#### ✅ Хорошие признаки:
```
✅ Конфигурация загружена
🖼️ Инициализация Gemini сервиса...
✅ Все сервисы инициализированы
🖼️ Генерация селфи через Gemini...
✅ Gemini успешно сгенерировал фото
```

### 3. Проверка API ключа Google

1. Откройте: https://aistudio.google.com/apikey
2. Найдите ключ: `AIzaSyApvDQafuIxHcAyBc5FVy_vbP8KuRNQJhc`
3. Проверьте:
   - ✅ Статус: Active
   - ✅ Quotas: Not exceeded
   - ✅ API: Gemini enabled

## 🚀 Быстрые команды

### Проверка статуса
```bash
# Debug endpoint
curl https://giottobright-back-3800.twc1.net/debug

# Health endpoint
curl https://giottobright-back-3800.twc1.net/health

# Ready endpoint
curl https://giottobright-back-3800.twc1.net/ready
```

### Ожидаемые ответы

#### /debug (с установленным ключом):
```json
{
  "initialized": true,
  "bot_is_none": false,
  "env_vars": {
    "GEMINI_API_KEY": "set"
  }
}
```

#### /health:
```json
{
  "status": "ok",
  "service": "hayalkiz-bot",
  "initialized": true
}
```

## 📊 Статистика времени решения

```
Диагностика:           30 секунд
Добавление переменной: 2 минуты
Перезапуск:           1 минута
Проверка:             30 секунд
─────────────────────────────────
ИТОГО:                ~5 минут
```

## 🎯 Следующие шаги

1. ✅ Прочитали диагностику
2. ⬜ Проверили /debug endpoint
3. ⬜ Определили проблему
4. ⬜ Следуете инструкции по решению
5. ⬜ Проверили результат
6. ⬜ Протестировали генерацию

---

**Готовы к решению?**  
→ Читайте **[PROD_FIX_STEPS_RU.md](PROD_FIX_STEPS_RU.md)** для пошаговой инструкции

